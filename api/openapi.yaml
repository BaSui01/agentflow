openapi: 3.0.3
info:
  title: AgentFlow API
  description: |
    AgentFlow is a production-ready Go framework for building AI agents with multi-provider LLM support.

    ## Features
    - Multi-provider LLM routing (OpenAI, Claude, Gemini, DeepSeek, etc.)
    - A2A (Agent-to-Agent) protocol support
    - MCP (Model Context Protocol) support
    - Streaming responses via SSE
    - Health monitoring and metrics

    ## Authentication
    Most endpoints require API key authentication via the `X-API-Key` header.
  version: 1.0.0
  contact:
    name: AgentFlow Team
    url: https://github.com/BaSui01/agentflow
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080
    description: Local development server
  - url: http://localhost:9090
    description: gRPC server (for reference)
  - url: http://localhost:9091
    description: Metrics server

tags:
  - name: Health
    description: Health check and readiness endpoints
  - name: Chat
    description: Chat completion endpoints
  - name: Providers
    description: LLM provider management
  - name: Models
    description: Model management
  - name: A2A
    description: Agent-to-Agent protocol endpoints
  - name: MCP
    description: Model Context Protocol endpoints

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Returns the health status of the service
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '503':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /ready:
    get:
      tags:
        - Health
      summary: Readiness check
      description: Returns whether the service is ready to accept requests
      operationId: readinessCheck
      responses:
        '200':
          description: Service is ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReadyResponse'
        '503':
          description: Service is not ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReadyResponse'

  /v1/chat/completions:
    post:
      tags:
        - Chat
      summary: Create chat completion
      description: |
        Creates a chat completion using the specified model and messages.
        Supports multi-provider routing based on cost, health, or QPS strategies.
      operationId: createChatCompletion
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
      responses:
        '200':
          description: Successful completion
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v1/chat/completions/stream:
    post:
      tags:
        - Chat
      summary: Create streaming chat completion
      description: |
        Creates a streaming chat completion using Server-Sent Events (SSE).
        Each chunk is sent as a separate SSE event.
      operationId: createStreamingChatCompletion
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
      responses:
        '200':
          description: Streaming response
          content:
            text/event-stream:
              schema:
                $ref: '#/components/schemas/StreamChunk'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v1/providers:
    get:
      tags:
        - Providers
      summary: List providers
      description: Returns a list of all configured LLM providers
      operationId: listProviders
      security:
        - ApiKeyAuth: []
      responses:
        '200':
          description: List of providers
          content:
            application/json:
              schema:
                type: object
                properties:
                  providers:
                    type: array
                    items:
                      $ref: '#/components/schemas/LLMProvider'

  /v1/providers/{providerId}:
    get:
      tags:
        - Providers
      summary: Get provider details
      description: Returns details of a specific provider
      operationId: getProvider
      security:
        - ApiKeyAuth: []
      parameters:
        - name: providerId
          in: path
          required: true
          schema:
            type: integer
            format: int64
          description: Provider ID
      responses:
        '200':
          description: Provider details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LLMProviderExtended'
        '404':
          description: Provider not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v1/providers/{providerId}/health:
    get:
      tags:
        - Providers
      summary: Check provider health
      description: Performs a health check on the specified provider
      operationId: checkProviderHealth
      security:
        - ApiKeyAuth: []
      parameters:
        - name: providerId
          in: path
          required: true
          schema:
            type: integer
            format: int64
          description: Provider ID
      responses:
        '200':
          description: Health status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'

  /v1/models:
    get:
      tags:
        - Models
      summary: List models
      description: Returns a list of all available models
      operationId: listModels
      security:
        - ApiKeyAuth: []
      parameters:
        - name: provider
          in: query
          schema:
            type: string
          description: Filter by provider code
        - name: enabled
          in: query
          schema:
            type: boolean
          description: Filter by enabled status
      responses:
        '200':
          description: List of models
          content:
            application/json:
              schema:
                type: object
                properties:
                  models:
                    type: array
                    items:
                      $ref: '#/components/schemas/LLMModel'

  /v1/models/{modelId}:
    get:
      tags:
        - Models
      summary: Get model details
      description: Returns details of a specific model
      operationId: getModel
      security:
        - ApiKeyAuth: []
      parameters:
        - name: modelId
          in: path
          required: true
          schema:
            type: integer
            format: int64
          description: Model ID
      responses:
        '200':
          description: Model details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LLMModelExtended'
        '404':
          description: Model not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v1/routing/select:
    post:
      tags:
        - Providers
      summary: Select provider for model
      description: |
        Selects the best provider for a given model based on the specified routing strategy.

        Available strategies:
        - `cost`: Select cheapest provider
        - `health`: Select healthiest provider
        - `qps`: Select provider with lowest current load
        - `canary`: Use canary deployment rules
      operationId: selectProvider
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RoutingRequest'
      responses:
        '200':
          description: Selected provider
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProviderSelection'
        '404':
          description: No suitable provider found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /.well-known/agent.json:
    get:
      tags:
        - A2A
      summary: Get agent card
      description: |
        Returns the A2A Agent Card describing this agent's capabilities.
        This endpoint follows the Google A2A specification for agent discovery.
      operationId: getAgentCard
      responses:
        '200':
          description: Agent card
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentCard'

  /a2a/invoke:
    post:
      tags:
        - A2A
      summary: Invoke agent
      description: |
        Invokes the agent with a task request following the A2A protocol.
        Supports both synchronous and streaming responses.
      operationId: invokeAgent
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/A2ARequest'
      responses:
        '200':
          description: Agent response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/A2AResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /a2a/invoke/stream:
    post:
      tags:
        - A2A
      summary: Invoke agent with streaming
      description: Invokes the agent and returns a streaming response via SSE
      operationId: invokeAgentStream
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/A2ARequest'
      responses:
        '200':
          description: Streaming response
          content:
            text/event-stream:
              schema:
                $ref: '#/components/schemas/A2AStreamEvent'

  /mcp/tools:
    get:
      tags:
        - MCP
      summary: List available tools
      description: Returns a list of all tools available via MCP
      operationId: listMCPTools
      security:
        - ApiKeyAuth: []
      responses:
        '200':
          description: List of tools
          content:
            application/json:
              schema:
                type: object
                properties:
                  tools:
                    type: array
                    items:
                      $ref: '#/components/schemas/ToolSchema'

  /mcp/tools/{toolName}/invoke:
    post:
      tags:
        - MCP
      summary: Invoke a tool
      description: Invokes a specific tool with the provided arguments
      operationId: invokeMCPTool
      security:
        - ApiKeyAuth: []
      parameters:
        - name: toolName
          in: path
          required: true
          schema:
            type: string
          description: Tool name
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ToolInvokeRequest'
      responses:
        '200':
          description: Tool result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ToolResult'
        '400':
          description: Invalid arguments
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Tool not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key for authentication

  schemas:
    HealthResponse:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum: [healthy, unhealthy]
          description: Health status
        version:
          type: string
          description: Service version
        uptime:
          type: string
          description: Service uptime duration

    ReadyResponse:
      type: object
      required:
        - ready
      properties:
        ready:
          type: boolean
          description: Whether the service is ready
        checks:
          type: object
          additionalProperties:
            type: boolean
          description: Individual readiness checks

    ChatRequest:
      type: object
      required:
        - model
        - messages
      properties:
        trace_id:
          type: string
          description: Trace ID for request tracking
        tenant_id:
          type: string
          description: Tenant ID for multi-tenancy
        user_id:
          type: string
          description: User ID
        model:
          type: string
          description: Model name (e.g., gpt-4, claude-3-opus)
          example: gpt-4
        messages:
          type: array
          items:
            $ref: '#/components/schemas/Message'
          description: Conversation messages
        max_tokens:
          type: integer
          minimum: 1
          description: Maximum tokens to generate
          example: 4096
        temperature:
          type: number
          format: float
          minimum: 0
          maximum: 2
          description: Sampling temperature
          example: 0.7
        top_p:
          type: number
          format: float
          minimum: 0
          maximum: 1
          description: Nucleus sampling parameter
          example: 1.0
        stop:
          type: array
          items:
            type: string
          description: Stop sequences
        tools:
          type: array
          items:
            $ref: '#/components/schemas/ToolSchema'
          description: Available tools for function calling
        tool_choice:
          type: string
          description: Tool choice mode (auto, none, or specific tool name)
          example: auto
        timeout:
          type: string
          description: Request timeout duration
          example: 30s
        metadata:
          type: object
          additionalProperties:
            type: string
          description: Custom metadata
        tags:
          type: array
          items:
            type: string
          description: Tags for routing
        reasoning_mode:
          type: string
          description: Reasoning mode for supported models
        previous_response_id:
          type: string
          description: Previous response ID for conversation continuity
        thought_signatures:
          type: array
          items:
            type: string
          description: Thought signatures for chain-of-thought

    ChatResponse:
      type: object
      required:
        - model
        - choices
        - usage
      properties:
        id:
          type: string
          description: Response ID
        provider:
          type: string
          description: Provider that handled the request
        model:
          type: string
          description: Model used
        choices:
          type: array
          items:
            $ref: '#/components/schemas/ChatChoice'
          description: Response choices
        usage:
          $ref: '#/components/schemas/ChatUsage'
        created_at:
          type: string
          format: date-time
          description: Response creation timestamp
        thought_signatures:
          type: array
          items:
            type: string
          description: Thought signatures from the response

    ChatChoice:
      type: object
      required:
        - index
        - message
      properties:
        index:
          type: integer
          description: Choice index
        finish_reason:
          type: string
          enum: [stop, length, tool_calls, content_filter]
          description: Reason for completion
        message:
          $ref: '#/components/schemas/Message'

    ChatUsage:
      type: object
      required:
        - prompt_tokens
        - completion_tokens
        - total_tokens
      properties:
        prompt_tokens:
          type: integer
          description: Tokens in the prompt
        completion_tokens:
          type: integer
          description: Tokens in the completion
        total_tokens:
          type: integer
          description: Total tokens used

    StreamChunk:
      type: object
      properties:
        id:
          type: string
          description: Chunk ID
        provider:
          type: string
          description: Provider name
        model:
          type: string
          description: Model name
        index:
          type: integer
          description: Choice index
        delta:
          $ref: '#/components/schemas/Message'
        finish_reason:
          type: string
          enum: [stop, length, tool_calls, content_filter]
          description: Finish reason (only in final chunk)
        usage:
          $ref: '#/components/schemas/ChatUsage'
        error:
          $ref: '#/components/schemas/ErrorDetail'

    Message:
      type: object
      required:
        - role
      properties:
        role:
          type: string
          enum: [system, user, assistant, tool]
          description: Message role
        content:
          type: string
          description: Message content
        name:
          type: string
          description: Name (for tool messages)
        tool_calls:
          type: array
          items:
            $ref: '#/components/schemas/ToolCall'
          description: Tool calls (for assistant messages)
        tool_call_id:
          type: string
          description: Tool call ID (for tool messages)
        images:
          type: array
          items:
            $ref: '#/components/schemas/ImageContent'
          description: Image content for multimodal messages
        metadata:
          type: object
          description: Custom metadata
        timestamp:
          type: string
          format: date-time
          description: Message timestamp

    ToolCall:
      type: object
      required:
        - id
        - name
        - arguments
      properties:
        id:
          type: string
          description: Tool call ID
        name:
          type: string
          description: Tool name
        arguments:
          type: object
          description: Tool arguments as JSON

    ImageContent:
      type: object
      required:
        - type
      properties:
        type:
          type: string
          enum: [url, base64]
          description: Image content type
        url:
          type: string
          format: uri
          description: Image URL (when type is url)
        data:
          type: string
          format: byte
          description: Base64 encoded image data (when type is base64)

    ToolSchema:
      type: object
      required:
        - name
        - parameters
      properties:
        name:
          type: string
          description: Tool name
        description:
          type: string
          description: Tool description
        parameters:
          type: object
          description: JSON Schema for tool parameters
        version:
          type: string
          description: Tool version

    ToolResult:
      type: object
      required:
        - tool_call_id
        - name
        - result
      properties:
        tool_call_id:
          type: string
          description: Tool call ID
        name:
          type: string
          description: Tool name
        result:
          type: object
          description: Tool result as JSON
        error:
          type: string
          description: Error message if execution failed
        duration:
          type: string
          description: Execution duration

    ToolInvokeRequest:
      type: object
      required:
        - arguments
      properties:
        arguments:
          type: object
          description: Tool arguments

    LLMProvider:
      type: object
      required:
        - id
        - code
        - name
        - status
      properties:
        id:
          type: integer
          format: int64
          description: Provider ID
        code:
          type: string
          description: Provider code (e.g., openai, anthropic)
        name:
          type: string
          description: Provider display name
        description:
          type: string
          description: Provider description
        status:
          type: integer
          enum: [0, 1, 2]
          description: |
            Provider status:
            - 0: Inactive
            - 1: Active
            - 2: Disabled
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    LLMProviderExtended:
      allOf:
        - $ref: '#/components/schemas/LLMProvider'
        - type: object
          properties:
            api_keys:
              type: array
              items:
                $ref: '#/components/schemas/LLMProviderAPIKey'
            provider_models:
              type: array
              items:
                $ref: '#/components/schemas/LLMProviderModel'

    LLMProviderAPIKey:
      type: object
      properties:
        id:
          type: integer
          format: int64
        provider_id:
          type: integer
          format: int64
        label:
          type: string
          description: Key label/name
        priority:
          type: integer
          description: Key priority
        weight:
          type: integer
          description: Key weight for load balancing
        enabled:
          type: boolean
        total_requests:
          type: integer
          format: int64
        failed_requests:
          type: integer
          format: int64
        last_used_at:
          type: string
          format: date-time
        rate_limit_rpm:
          type: integer
          description: Rate limit (requests per minute)
        rate_limit_rpd:
          type: integer
          description: Rate limit (requests per day)

    LLMModel:
      type: object
      required:
        - id
        - model_name
      properties:
        id:
          type: integer
          format: int64
        model_name:
          type: string
          description: Model identifier
        display_name:
          type: string
          description: Display name
        description:
          type: string
        enabled:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    LLMModelExtended:
      allOf:
        - $ref: '#/components/schemas/LLMModel'
        - type: object
          properties:
            provider_models:
              type: array
              items:
                $ref: '#/components/schemas/LLMProviderModel'

    LLMProviderModel:
      type: object
      properties:
        id:
          type: integer
          format: int64
        model_id:
          type: integer
          format: int64
        provider_id:
          type: integer
          format: int64
        remote_model_name:
          type: string
          description: Model name as known by the provider
        base_url:
          type: string
          description: Provider base URL
        price_input:
          type: number
          format: double
          description: Price per 1K input tokens
        price_completion:
          type: number
          format: double
          description: Price per 1K completion tokens
        max_tokens:
          type: integer
          description: Maximum context length
        priority:
          type: integer
        enabled:
          type: boolean

    HealthStatus:
      type: object
      required:
        - healthy
      properties:
        healthy:
          type: boolean
          description: Whether the provider is healthy
        latency:
          type: string
          description: Response latency
        error_rate:
          type: number
          format: double
          description: Error rate (0-1)

    RoutingRequest:
      type: object
      required:
        - model
        - strategy
      properties:
        model:
          type: string
          description: Model name to route
        strategy:
          type: string
          enum: [cost, health, qps, canary, tag]
          description: Routing strategy
        tags:
          type: array
          items:
            type: string
          description: Tags for tag-based routing

    ProviderSelection:
      type: object
      required:
        - provider_id
        - provider_code
        - model_id
        - model_name
      properties:
        provider_id:
          type: integer
          format: int64
        provider_code:
          type: string
        model_id:
          type: integer
          format: int64
        model_name:
          type: string
        is_canary:
          type: boolean
          description: Whether this is a canary deployment
        strategy:
          type: string
          description: Strategy used for selection

    AgentCard:
      type: object
      required:
        - name
        - description
        - url
        - version
        - capabilities
      properties:
        name:
          type: string
          description: Agent name
        description:
          type: string
          description: Agent description
        url:
          type: string
          format: uri
          description: Agent endpoint URL
        version:
          type: string
          description: Agent version
        capabilities:
          type: array
          items:
            $ref: '#/components/schemas/Capability'
        input_schema:
          type: object
          description: JSON Schema for agent input
        output_schema:
          type: object
          description: JSON Schema for agent output
        tools:
          type: array
          items:
            $ref: '#/components/schemas/ToolDefinition'
        metadata:
          type: object
          additionalProperties:
            type: string

    Capability:
      type: object
      required:
        - name
        - description
        - type
      properties:
        name:
          type: string
          description: Capability name
        description:
          type: string
          description: Capability description
        type:
          type: string
          enum: [task, query, stream]
          description: Capability type

    ToolDefinition:
      type: object
      required:
        - name
        - description
      properties:
        name:
          type: string
          description: Tool name
        description:
          type: string
          description: Tool description
        parameters:
          type: object
          description: JSON Schema for tool parameters

    A2ARequest:
      type: object
      required:
        - task
      properties:
        task:
          type: string
          description: Task description or query
        context:
          type: object
          description: Additional context
        stream:
          type: boolean
          description: Whether to stream the response

    A2AResponse:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum: [success, error, pending]
        result:
          type: object
          description: Task result
        error:
          type: string
          description: Error message if failed

    A2AStreamEvent:
      type: object
      properties:
        event:
          type: string
          enum: [start, progress, complete, error]
        data:
          type: object
          description: Event data

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          $ref: '#/components/schemas/ErrorDetail'

    ErrorDetail:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          description: Error code
          enum:
            - INVALID_REQUEST
            - AUTHENTICATION
            - UNAUTHORIZED
            - FORBIDDEN
            - RATE_LIMIT
            - RATE_LIMITED
            - QUOTA_EXCEEDED
            - MODEL_NOT_FOUND
            - CONTEXT_TOO_LONG
            - CONTENT_FILTERED
            - MODEL_OVERLOADED
            - UPSTREAM_TIMEOUT
            - TIMEOUT
            - UPSTREAM_ERROR
            - INTERNAL_ERROR
            - SERVICE_UNAVAILABLE
            - PROVIDER_UNAVAILABLE
        message:
          type: string
          description: Human-readable error message
        http_status:
          type: integer
          description: HTTP status code
        retryable:
          type: boolean
          description: Whether the request can be retried
        provider:
          type: string
          description: Provider that returned the error
