openapi: 3.0.3
info:
  title: AgentFlow Runtime API
  description: |
    OpenAPI contract for endpoints currently exposed by `cmd/agentflow` runtime.

    Notes:
    - API key authentication is accepted via `X-API-Key` header.
    - Query-string `api_key` is disabled by default for security reasons.
  version: 1.0.1
  contact:
    name: AgentFlow Team
    url: https://github.com/BaSui01/agentflow
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080
    description: HTTP API server

tags:
  - name: Health
    description: Health and readiness endpoints
  - name: Config
    description: Runtime configuration management endpoints
  - name: Chat
    description: LLM chat completion endpoints
  - name: Agent
    description: Agent management and execution endpoints
  - name: Provider
    description: LLM provider and API key management endpoints

paths:
  /health:
    get:
      tags: [Health]
      summary: Health check
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'

  /healthz:
    get:
      tags: [Health]
      summary: Liveness probe
      operationId: healthz
      responses:
        '200':
          description: Service process is alive
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'

  /ready:
    get:
      tags: [Health]
      summary: Readiness probe
      operationId: readiness
      responses:
        '200':
          description: Service is ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'
        '503':
          description: Service is not ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'

  /readyz:
    get:
      tags: [Health]
      summary: Alternate readiness probe
      operationId: readinessZ
      responses:
        '200':
          description: Service is ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'
        '503':
          description: Service is not ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'

  /version:
    get:
      tags: [Health]
      summary: Build version info
      operationId: version
      responses:
        '200':
          description: Version information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Envelope'

  /api/v1/chat/completions:
    post:
      tags: [Chat]
      summary: Chat completion
      operationId: chatCompletion
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
      responses:
        '200':
          description: Chat completion response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Envelope'
        '400':
          description: Invalid request
        '500':
          description: Internal error

  /api/v1/chat/completions/stream:
    post:
      tags: [Chat]
      summary: Streaming chat completion (SSE)
      operationId: chatCompletionStream
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
      responses:
        '200':
          description: SSE stream of chat completion chunks
          content:
            text/event-stream:
              schema:
                type: string
        '400':
          description: Invalid request
        '500':
          description: Internal error

  /api/v1/config:
    get:
      tags: [Config]
      summary: Get current runtime config (sanitized)
      operationId: getConfig
      security:
        - ApiKeyAuth: []
      responses:
        '200':
          description: Current sanitized configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigResponse'
    put:
      tags: [Config]
      summary: Update runtime config fields
      operationId: updateConfig
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfigUpdateRequest'
      responses:
        '200':
          description: Update applied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigResponse'
        '400':
          description: Invalid update request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigResponse'

  /api/v1/config/reload:
    post:
      tags: [Config]
      summary: Reload config from file
      operationId: reloadConfig
      security:
        - ApiKeyAuth: []
      responses:
        '200':
          description: Reload succeeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigResponse'
        '500':
          description: Reload failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigResponse'

  /api/v1/config/fields:
    get:
      tags: [Config]
      summary: List hot-reloadable fields
      operationId: listConfigFields
      security:
        - ApiKeyAuth: []
      responses:
        '200':
          description: Hot-reloadable fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigResponse'

  /api/v1/config/changes:
    get:
      tags: [Config]
      summary: List recent config changes
      operationId: listConfigChanges
      security:
        - ApiKeyAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            default: 50
      responses:
        '200':
          description: Change log
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigResponse'

  /api/v1/agents:
    get:
      tags: [Agent]
      summary: List agents
      operationId: listAgents
      security:
        - ApiKeyAuth: []
      responses:
        '200':
          description: Agent list
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Envelope'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/AgentInfo'
        '500':
          description: Internal error

  /api/v1/agents/execute:
    post:
      tags: [Agent]
      summary: Execute agent
      operationId: executeAgent
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AgentExecuteRequest'
      responses:
        '200':
          description: Execution result
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Envelope'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/AgentExecuteResponse'
        '400':
          description: Invalid request
        '404':
          description: Agent not found
        '500':
          description: Execution failed

  /api/v1/agents/execute/stream:
    post:
      tags: [Agent]
      summary: Stream agent execution (SSE)
      operationId: executeAgentStream
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AgentExecuteRequest'
      responses:
        '200':
          description: SSE stream of agent execution events (token, tool_call, tool_result, error, [DONE])
          content:
            text/event-stream:
              schema:
                type: string
        '400':
          description: Invalid request
        '404':
          description: Agent not found
        '500':
          description: Execution failed

  /api/v1/agents/plan:
    post:
      tags: [Agent]
      summary: Plan agent execution
      operationId: planAgent
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AgentExecuteRequest'
      responses:
        '200':
          description: Execution plan
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Envelope'
        '400':
          description: Invalid request
        '404':
          description: Agent not found
        '500':
          description: Plan failed

  /api/v1/agents/health:
    get:
      tags: [Agent]
      summary: Agent health check
      operationId: agentHealth
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: string
          description: Agent ID
      responses:
        '200':
          description: Agent is healthy
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Envelope'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/AgentHealthResponse'
        '400':
          description: Invalid agent ID
        '404':
          description: Agent not found
        '503':
          description: Agent not ready
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Envelope'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/AgentHealthResponse'

  /api/v1/providers:
    get:
      tags: [Provider]
      summary: List all LLM providers
      operationId: listProviders
      security:
        - ApiKeyAuth: []
      responses:
        '200':
          description: Provider list
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Envelope'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Provider'

  /api/v1/providers/{id}/api-keys:
    get:
      tags: [Provider]
      summary: List API keys for a provider
      operationId: listAPIKeys
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: Provider ID
      responses:
        '200':
          description: API key list
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Envelope'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/APIKeyResponse'
    post:
      tags: [Provider]
      summary: Create API key for a provider
      operationId: createAPIKey
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: Provider ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateAPIKeyRequest'
      responses:
        '201':
          description: API key created
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Envelope'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/APIKeyResponse'
        '400':
          description: Invalid request

  /api/v1/providers/{id}/api-keys/stats:
    get:
      tags: [Provider]
      summary: Get API key stats for a provider
      operationId: getAPIKeyStats
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: Provider ID
      responses:
        '200':
          description: API key statistics
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Envelope'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/APIKeyStats'

  /api/v1/providers/{id}/api-keys/{keyId}:
    put:
      tags: [Provider]
      summary: Update an API key
      operationId: updateAPIKey
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: Provider ID
        - name: keyId
          in: path
          required: true
          schema:
            type: integer
          description: API Key ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateAPIKeyRequest'
      responses:
        '200':
          description: API key updated
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Envelope'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/APIKeyResponse'
        '404':
          description: API key not found
    delete:
      tags: [Provider]
      summary: Delete an API key
      operationId: deleteAPIKey
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: Provider ID
        - name: keyId
          in: path
          required: true
          schema:
            type: integer
          description: API Key ID
      responses:
        '200':
          description: API key deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Envelope'
        '404':
          description: API key not found

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key

  schemas:
    Envelope:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          additionalProperties: true
        error:
          type: object
          additionalProperties: true
        timestamp:
          type: string
          format: date-time

    HealthStatus:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        timestamp:
          type: string
          format: date-time
        version:
          type: string
        checks:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/CheckResult'

    CheckResult:
      type: object
      properties:
        status:
          type: string
          enum: [pass, fail]
        message:
          type: string
        latency:
          type: string

    ConfigUpdateRequest:
      type: object
      required: [updates]
      properties:
        updates:
          type: object
          additionalProperties: true

    ConfigResponse:
      description: Config API responses use the unified Envelope structure. The data field contains config-specific fields.
      allOf:
        - $ref: '#/components/schemas/Envelope'
        - type: object
          properties:
            data:
              type: object
              properties:
                message:
                  type: string
                config:
                  type: object
                  additionalProperties: true
                fields:
                  type: object
                  additionalProperties: true
                changes:
                  type: array
                  items:
                    type: object
                    additionalProperties: true
                requires_restart:
                  type: boolean

    ChatRequest:
      type: object
      required: [messages]
      properties:
        model:
          type: string
        messages:
          type: array
          items:
            type: object
            properties:
              role:
                type: string
                enum: [system, user, assistant]
              content:
                type: string
        max_tokens:
          type: integer
        temperature:
          type: number
        stream:
          type: boolean

    AgentInfo:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        type:
          type: string
        state:
          type: string
        description:
          type: string
        model:
          type: string
        created_at:
          type: string

    AgentExecuteRequest:
      type: object
      required: [agent_id, content]
      properties:
        agent_id:
          type: string
        content:
          type: string
        context:
          type: object
          additionalProperties: true
        variables:
          type: object
          additionalProperties:
            type: string

    AgentExecuteResponse:
      type: object
      properties:
        trace_id:
          type: string
        content:
          type: string
        metadata:
          type: object
          additionalProperties: true
        tokens_used:
          type: integer
        cost:
          type: number
        duration:
          type: string
        finish_reason:
          type: string

    AgentHealthResponse:
      type: object
      properties:
        agent_id:
          type: string
        status:
          type: string
        healthy:
          type: boolean
        endpoint:
          type: string
        load:
          type: number
        checked_at:
          type: string

    Provider:
      type: object
      properties:
        id:
          type: integer
        code:
          type: string
        name:
          type: string
        description:
          type: string
        status:
          type: integer
          description: "0=inactive, 1=active, 2=disabled"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    APIKeyResponse:
      type: object
      properties:
        id:
          type: integer
        provider_id:
          type: integer
        api_key:
          type: string
          description: Masked API key (only last 4 chars visible)
        base_url:
          type: string
        label:
          type: string
        priority:
          type: integer
        weight:
          type: integer
        enabled:
          type: boolean
        total_requests:
          type: integer
          format: int64
        failed_requests:
          type: integer
          format: int64
        rate_limit_rpm:
          type: integer
        rate_limit_rpd:
          type: integer

    CreateAPIKeyRequest:
      type: object
      required: [api_key]
      properties:
        api_key:
          type: string
        base_url:
          type: string
        label:
          type: string
        priority:
          type: integer
          minimum: 0
        weight:
          type: integer
          minimum: 0
        enabled:
          type: boolean
          default: true
        rate_limit_rpm:
          type: integer
          minimum: 0
        rate_limit_rpd:
          type: integer
          minimum: 0

    UpdateAPIKeyRequest:
      type: object
      properties:
        base_url:
          type: string
        label:
          type: string
        priority:
          type: integer
          minimum: 0
        weight:
          type: integer
          minimum: 0
        enabled:
          type: boolean
        rate_limit_rpm:
          type: integer
          minimum: 0
        rate_limit_rpd:
          type: integer
          minimum: 0

    APIKeyStats:
      type: object
      properties:
        key_id:
          type: integer
        label:
          type: string
        base_url:
          type: string
        enabled:
          type: boolean
        is_healthy:
          type: boolean
        total_requests:
          type: integer
          format: int64
        failed_requests:
          type: integer
          format: int64
        success_rate:
          type: number
          format: double
        current_rpm:
          type: integer
        current_rpd:
          type: integer
        last_used_at:
          type: string
          format: date-time
          nullable: true
        last_error_at:
          type: string
          format: date-time
          nullable: true
        last_error:
          type: string
