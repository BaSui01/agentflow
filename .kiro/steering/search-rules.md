# 代码搜索规则

## 上下文搜索工具使用规范

### 主要规则

**始终优先使用 ACE 工具进行代码搜索**

当需要搜索代码库、查找函数、类、或理解代码结构时，必须使用 `mcp_ace_tool_search_context` 工具（ACE 上下文搜索引擎）。

### 为什么使用 ACE 工具？

ACE (Augment Context Engine) 是专为代码库设计的语义搜索引擎，具有以下优势：

1. **语义理解**：理解代码的含义和上下文，而不仅仅是字符串匹配
2. **实时索引**：始终反映代码库的最新状态
3. **高质量召回**：使用专有的检索/嵌入模型，提供最相关的代码片段
4. **跨语言支持**：支持多种编程语言的搜索
5. **智能排序**：根据相关性自动排序搜索结果

### 使用场景

#### ✅ 应该使用 ACE 工具的场景

- 查找特定功能的实现位置
- 理解代码库的整体结构
- 寻找相关的测试代码
- 了解某个功能是如何实现的
- 查找类、函数、接口的定义
- 理解模块之间的关系
- 探索不熟悉的代码库

**示例查询：**
- "用户认证功能在哪里实现？"
- "有哪些测试覆盖了登录功能？"
- "数据库连接是如何建立的？"
- "LLM 提供商的接口定义在哪里？"
- "工作流编排的核心逻辑"

#### ❌ 不应该使用 ACE 工具的场景

以下场景应该使用 `grepSearch` 工具：

- 查找某个标识符的所有引用
- 精确的字符串匹配
- 查找配置值或错误消息
- 在特定文件中搜索

**示例查询：**
- "找到 Foo 类构造函数的定义" → 使用 grep
- "找到函数 bar 的所有引用" → 使用 grep
- "在 services/payment.py 中查看 Checkout 类的使用" → 使用文件查看工具

### 工具调用示例

```
使用 mcp_ace_tool_search_context 工具：
- project_root_path: 项目根目录的绝对路径（从工作区信息获取）
- query: 自然语言描述 + 可选关键词

示例：
query: "我想找到文件上传过程中服务器处理分块合并的位置。关键词：upload chunk merge, file service"
```

### 搜索策略

1. **首次搜索**：使用 ACE 工具进行语义搜索，理解代码结构
2. **精确定位**：如果需要找到所有引用，使用 grep 工具
3. **文件查看**：确定文件后，使用 readFile 查看具体内容

### 性能考虑

- ACE 工具针对语义理解优化，适合探索性搜索
- grep 工具针对精确匹配优化，适合已知标识符的查找
- 合理组合使用两种工具，提高搜索效率

## 集成到工作流

### 任务开始前

在开始任何编辑或实现任务之前，使用 ACE 工具：
1. 理解相关代码的位置和结构
2. 查找所有相关的符号、类、方法
3. 了解依赖关系和调用链

### 编辑文件前

在编辑文件之前，使用 ACE 工具获取详细信息：
- 查找要调用的方法所在的类
- 了解类的实例和属性
- 理解相关的接口和实现

### 一次性查询

尽量在一次 ACE 工具调用中获取所有需要的信息，避免多次调用。

**示例：**
如果要编辑涉及多个类的代码，一次性查询：
"我需要了解 Agent 类的状态管理、Memory 接口的实现、以及 ToolManager 的工具注册机制"

## 注意事项

- ACE 工具只反映磁盘上的当前代码状态，不包含版本控制历史
- 搜索结果限制为 50 个匹配项
- 提供清晰的自然语言描述可以获得更好的搜索结果
- 可以添加关键词来提高语义匹配的准确性
