name: CI

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Verify gofmt
        run: test -z "$(gofmt -l .)"

      - name: Vet
        run: go vet ./...

      - name: golangci-lint
        run: |
          go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.62.0
          "$(go env GOPATH)/bin/golangci-lint" run

      - name: staticcheck
        run: |
          go install honnef.co/go/tools/cmd/staticcheck@2025.1.1
          "$(go env GOPATH)/bin/staticcheck" -checks=SA* ./...

      - name: Test (with coverage)
        run: |
          go test ./... -covermode atomic -coverprofile coverage.out -count=1
          total="$(go tool cover -func coverage.out | awk '/^total:/{gsub(/%/,"",$NF); print $NF}')"
          echo "Total coverage: ${total}%"
          threshold="24.0"
          awk -v total="${total}" -v threshold="${threshold}" 'BEGIN { exit (total+0 < threshold+0) }'

      - name: Test (key-path coverage)
        run: |
          go test ./types ./llm ./llm/cache ./llm/middleware ./llm/observability ./llm/retry ./llm/router ./llm/tools ./rag ./workflow ./agent ./agent/context -covermode atomic -coverprofile coverage.key.out -count=1
          total="$(go tool cover -func coverage.key.out | awk '/^total:/{gsub(/%/,"",$NF); print $NF}')"
          echo "Key-path coverage: ${total}%"
          threshold="30.0"
          awk -v total="${total}" -v threshold="${threshold}" 'BEGIN { exit (total+0 < threshold+0) }'

      - name: Race
        env:
          CGO_ENABLED: "1"
        run: go test -race ./...

  # =============================================================================
  # ðŸ”’ å®‰å…¨æ‰«æ Job
  # =============================================================================
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      # -------------------------------------------------------------------------
      # gosec - Go å®‰å…¨æ‰«æå™¨
      # æ£€æµ‹: SQLæ³¨å…¥ã€ç¡¬ç¼–ç å¯†é’¥ã€ä¸å®‰å…¨çš„éšæœºæ•°ã€è·¯å¾„éåŽ†ç­‰
      # -------------------------------------------------------------------------
      - name: ðŸ” Security scanning (gosec)
        run: |
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          "$(go env GOPATH)/bin/gosec" -fmt=json -out=gosec-results.json ./... || true
          "$(go env GOPATH)/bin/gosec" -fmt=text ./...

      # -------------------------------------------------------------------------
      # govulncheck - Go å®˜æ–¹æ¼æ´žæ£€æŸ¥å™¨
      # æ£€æµ‹: ä¾èµ–åº“ä¸­çš„å·²çŸ¥å®‰å…¨æ¼æ´ž (CVE)
      # -------------------------------------------------------------------------
      - name: ðŸ›¡ï¸ Vulnerability check (govulncheck)
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          "$(go env GOPATH)/bin/govulncheck" ./...

      # -------------------------------------------------------------------------
      # ä¸Šä¼ å®‰å…¨æ‰«æç»“æžœ (å¯é€‰)
      # -------------------------------------------------------------------------
      - name: ðŸ“¤ Upload security scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-results
          path: gosec-results.json
          retention-days: 30

  # =============================================================================
  # ðŸ“¦ ä¾èµ–å®¡è®¡ Job
  # =============================================================================
  dependency-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      # -------------------------------------------------------------------------
      # æ£€æŸ¥ go.mod å’Œ go.sum ä¸€è‡´æ€§
      # -------------------------------------------------------------------------
      - name: ðŸ”„ Verify go.mod tidy
        run: |
          go mod tidy
          git diff --exit-code go.mod go.sum

      # -------------------------------------------------------------------------
      # æ£€æŸ¥ä¾èµ–è®¸å¯è¯åˆè§„æ€§
      # -------------------------------------------------------------------------
      - name: ðŸ“œ License check
        run: |
          go install github.com/google/go-licenses@latest
          "$(go env GOPATH)/bin/go-licenses" check ./... --disallowed_types=forbidden,restricted || echo "âš ï¸ License check completed with warnings"

  # =============================================================================
  # ðŸ—ï¸ æž„å»ºéªŒè¯ Job
  # =============================================================================
  build:
    runs-on: ubuntu-latest
    needs: [test, security]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      # -------------------------------------------------------------------------
      # å¤šå¹³å°æž„å»ºéªŒè¯
      # -------------------------------------------------------------------------
      - name: ðŸ”¨ Build (linux/amd64)
        env:
          CGO_ENABLED: "0"
          GOOS: linux
          GOARCH: amd64
        run: go build -o /dev/null ./...

      - name: ðŸ”¨ Build (linux/arm64)
        env:
          CGO_ENABLED: "0"
          GOOS: linux
          GOARCH: arm64
        run: go build -o /dev/null ./...

      - name: ðŸ”¨ Build (darwin/amd64)
        env:
          CGO_ENABLED: "0"
          GOOS: darwin
          GOARCH: amd64
        run: go build -o /dev/null ./...

      - name: ðŸ”¨ Build (windows/amd64)
        env:
          CGO_ENABLED: "0"
          GOOS: windows
          GOARCH: amd64
        run: go build -o /dev/null ./...
