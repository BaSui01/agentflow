# =============================================================================
# AgentFlow Docker Compose - Local Development Environment
# =============================================================================
# Complete development environment: Main service + Redis + PostgreSQL + Qdrant + Weaviate + Monitoring
#
# Usage:
#   docker-compose up -d              # ÂêØÂä®ÊâÄÊúâÊúçÂä°
#   docker-compose up -d agentflow    # ‰ªÖÂêØÂä®‰∏ªÊúçÂä°
#   docker-compose logs -f agentflow  # Êü•ÁúãÊó•Âøó
#   docker-compose down               # ÂÅúÊ≠¢ÊâÄÊúâÊúçÂä°
#   docker-compose down -v            # ÂÅúÊ≠¢Âπ∂Âà†Èô§Êï∞ÊçÆÂç∑
# =============================================================================

version: "3.9"

services:
  # ---------------------------------------------------------------------------
  # üöÄ AgentFlow ‰∏ªÊúçÂä°
  # ---------------------------------------------------------------------------
  agentflow:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VERSION: ${VERSION:-dev}
    image: agentflow:${VERSION:-dev}
    container_name: agentflow
    restart: unless-stopped
    ports:
      - "8080:8080"   # HTTP API
      - "9090:9090"   # gRPC
      - "9091:9091"   # Prometheus ÊåáÊ†á
    environment:
      # ÊúçÂä°ÈÖçÁΩÆ
      AGENTFLOW_SERVER_HTTP_PORT: "8080"
      AGENTFLOW_SERVER_GRPC_PORT: "9090"
      AGENTFLOW_SERVER_METRICS_PORT: "9091"
      # Redis ÈÖçÁΩÆ
      AGENTFLOW_REDIS_ADDR: "redis:6379"
      AGENTFLOW_REDIS_PASSWORD: ""
      AGENTFLOW_REDIS_DB: "0"
      # PostgreSQL ÈÖçÁΩÆ
      AGENTFLOW_DATABASE_HOST: "postgres"
      AGENTFLOW_DATABASE_PORT: "5432"
      AGENTFLOW_DATABASE_USER: "agentflow"
      AGENTFLOW_DATABASE_PASSWORD: "agentflow_secret"
      AGENTFLOW_DATABASE_NAME: "agentflow"
      # Qdrant ÈÖçÁΩÆ
      AGENTFLOW_QDRANT_HOST: "qdrant"
      AGENTFLOW_QDRANT_PORT: "6334"
      # Êó•ÂøóÈÖçÁΩÆ
      AGENTFLOW_LOG_LEVEL: "info"
      AGENTFLOW_LOG_FORMAT: "json"
    volumes:
      - ./config:/app/config:ro
      - agentflow_data:/app/data
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - agentflow-network

  # ---------------------------------------------------------------------------
  # üî¥ Redis - Áü≠ÊúüËÆ∞ÂøÜÁºìÂ≠ò
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: agentflow-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - agentflow-network

  # ---------------------------------------------------------------------------
  # üêò PostgreSQL - ÂÖÉÊï∞ÊçÆÂ≠òÂÇ®
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:16-alpine
    container_name: agentflow-postgres
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: agentflow
      POSTGRES_PASSWORD: agentflow_secret
      POSTGRES_DB: agentflow
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U agentflow -d agentflow"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - agentflow-network

  # ---------------------------------------------------------------------------
  # Qdrant - Vector Store
  # ---------------------------------------------------------------------------
  qdrant:
    image: qdrant/qdrant:v1.7.4
    container_name: agentflow-qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"   # REST API
      - "6334:6334"   # gRPC
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      QDRANT__SERVICE__GRPC_PORT: "6334"
    networks:
      - agentflow-network

  # ---------------------------------------------------------------------------
  # Weaviate - Vector Store (Alternative)
  # ---------------------------------------------------------------------------
  # Weaviate is an open-source vector database with built-in:
  # - Vector search (HNSW)
  # - BM25 keyword search
  # - Hybrid search (vector + BM25)
  # - GraphQL API
  #
  # Enable with: docker-compose --profile weaviate up -d
  # ---------------------------------------------------------------------------
  weaviate:
    image: semitechnologies/weaviate:1.24.1
    container_name: agentflow-weaviate
    restart: unless-stopped
    profiles:
      - weaviate
    ports:
      - "8081:8080"   # REST/GraphQL API
      - "50051:50051" # gRPC
    environment:
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: "true"
      PERSISTENCE_DATA_PATH: "/var/lib/weaviate"
      DEFAULT_VECTORIZER_MODULE: "none"
      ENABLE_MODULES: ""
      CLUSTER_HOSTNAME: "node1"
      # Performance tuning
      LIMIT_RESOURCES: "false"
      GOMAXPROCS: "4"
      # Logging
      LOG_LEVEL: "info"
      LOG_FORMAT: "json"
    volumes:
      - weaviate_data:/var/lib/weaviate
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/v1/.well-known/ready"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - agentflow-network

  # ---------------------------------------------------------------------------
  # Milvus - Vector Store (Alternative)
  # ---------------------------------------------------------------------------
  # Milvus is a high-performance vector database with:
  # - Multiple index types (IVF_FLAT, HNSW, IVF_SQ8, IVF_PQ)
  # - GPU acceleration support
  # - Distributed architecture
  # - REST API (v2)
  #
  # Enable with: docker-compose --profile milvus up -d
  #
  # Note: Milvus requires etcd and MinIO for metadata and object storage.
  # This is a standalone deployment suitable for development/testing.
  # For production, consider using Milvus Operator on Kubernetes.
  # ---------------------------------------------------------------------------
  etcd:
    image: quay.io/coreos/etcd:v3.5.11
    container_name: agentflow-milvus-etcd
    restart: unless-stopped
    profiles:
      - milvus
    environment:
      ETCD_AUTO_COMPACTION_MODE: revision
      ETCD_AUTO_COMPACTION_RETENTION: "1000"
      ETCD_QUOTA_BACKEND_BYTES: "4294967296"
      ETCD_SNAPSHOT_COUNT: "50000"
    volumes:
      - milvus_etcd_data:/etcd
    command: etcd -advertise-client-urls=http://127.0.0.1:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - agentflow-network

  minio:
    image: minio/minio:RELEASE.2024-01-16T16-07-38Z
    container_name: agentflow-milvus-minio
    restart: unless-stopped
    profiles:
      - milvus
    environment:
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - milvus_minio_data:/minio_data
    command: minio server /minio_data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - agentflow-network

  milvus:
    image: milvusdb/milvus:v2.3.7
    container_name: agentflow-milvus
    restart: unless-stopped
    profiles:
      - milvus
    command: ["milvus", "run", "standalone"]
    security_opt:
      - seccomp:unconfined
    environment:
      ETCD_ENDPOINTS: etcd:2379
      MINIO_ADDRESS: minio:9000
      MINIO_ACCESS_KEY_ID: minioadmin
      MINIO_SECRET_ACCESS_KEY: minioadmin
      # Common configuration
      COMMON_STORAGETYPE: minio
      # Performance tuning
      QUERYNODE_GRACEFULTIME: "5000"
      QUERYCOORD_ENABLEACTIVESTANDBY: "false"
    volumes:
      - milvus_data:/var/lib/milvus
    ports:
      - "19530:19530"  # gRPC/REST API
      - "9091:9091"    # Metrics (conflicts with agentflow, change if needed)
    depends_on:
      etcd:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]
      interval: 30s
      timeout: 20s
      retries: 3
      start_period: 90s
    networks:
      - agentflow-network

  # ---------------------------------------------------------------------------
  # Prometheus - Metrics Collection (Optional)
  # ---------------------------------------------------------------------------
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: agentflow-prometheus
    restart: unless-stopped
    profiles:
      - monitoring
    ports:
      - "9092:9090"
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
    volumes:
      - ./deployments/docker/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    networks:
      - agentflow-network

  # ---------------------------------------------------------------------------
  # üìà Grafana - ÂèØËßÜÂåñ‰ª™Ë°®ÁõòÔºàÂèØÈÄâÔºâ
  # ---------------------------------------------------------------------------
  grafana:
    image: grafana/grafana:10.2.2
    container_name: agentflow-grafana
    restart: unless-stopped
    profiles:
      - monitoring
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus
    networks:
      - agentflow-network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  agentflow_data:
    driver: local
  redis_data:
    driver: local
  postgres_data:
    driver: local
  qdrant_data:
    driver: local
  weaviate_data:
    driver: local
  milvus_data:
    driver: local
  milvus_etcd_data:
    driver: local
  milvus_minio_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  agentflow-network:
    driver: bridge
    name: agentflow-network
