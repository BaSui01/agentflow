# 多 Agent 协作

AgentFlow 支持多种多 Agent 协作模式，包括层级 Agent、辩论、共识、流水线、广播和网络模式。

## 层级 Agent (Supervisor-Worker)

监督者分解任务，工作者并行执行：

```go
import "github.com/BaSui01/agentflow/agent/hierarchical"

// 创建监督者 Agent
supervisor := createSupervisorAgent(provider, logger)

// 创建工作者 Agent 池
workers := []agent.Agent{
    createWorkerAgent("researcher", provider, logger),
    createWorkerAgent("analyst", provider, logger),
    createWorkerAgent("writer", provider, logger),
}

// 创建层级 Agent
hierarchicalAgent := hierarchical.NewHierarchicalAgent(
    baseAgent,
    supervisor,
    workers,
    hierarchical.HierarchicalConfig{
        MaxWorkers:        5,
        TaskTimeout:       5 * time.Minute,
        EnableRetry:       true,
        MaxRetries:        3,
        WorkerSelection:   "least_loaded", // round_robin/least_loaded/random
        EnableLoadBalance: true,
    },
    logger,
)

// 执行任务
result, err := hierarchicalAgent.Execute(ctx, &agent.Input{
    Content: "研究 Go 语言的并发模型并撰写技术报告",
})
```

### 工作者选择策略

| 策略 | 说明 |
|------|------|
| `round_robin` | 轮询分配 |
| `least_loaded` | 选择负载最低的工作者 |
| `random` | 随机选择 |

### 任务协调器

```go
// 获取工作者状态
status := hierarchicalAgent.GetWorkerStatus()
for id, ws := range status {
    fmt.Printf("工作者 %s: 状态=%s, 完成=%d, 失败=%d\n",
        id, ws.Status, ws.CompletedTasks, ws.FailedTasks)
}
```

## 多 Agent 系统

### 创建多 Agent 系统

```go
import "github.com/BaSui01/agentflow/agent/collaboration"

// 创建多个 Agent
agents := []agent.Agent{
    createAgent("expert1", "你是一个乐观的分析师"),
    createAgent("expert2", "你是一个谨慎的风险评估师"),
    createAgent("expert3", "你是一个创新的策略师"),
}

// 创建多 Agent 系统
mas := collaboration.NewMultiAgentSystem(agents, collaboration.MultiAgentConfig{
    Pattern:            collaboration.PatternDebate,
    MaxRounds:          5,
    ConsensusThreshold: 0.7,
    Timeout:            10 * time.Minute,
    EnableVoting:       true,
}, logger)

// 执行协作任务
result, err := mas.Execute(ctx, &agent.Input{
    Content: "评估这个投资方案的可行性",
})
```

### 协作模式

#### 辩论模式 (Debate)

多个 Agent 提出观点，相互评论和改进：

```go
mas := collaboration.NewMultiAgentSystem(agents, collaboration.MultiAgentConfig{
    Pattern:   collaboration.PatternDebate,
    MaxRounds: 5, // 辩论轮次
}, logger)

// 流程：
// 1. 每个 Agent 提出初始观点
// 2. 多轮辩论，每个 Agent 评论其他观点
// 3. 选择最佳答案
```

#### 共识模式 (Consensus)

所有 Agent 投票达成共识：

```go
mas := collaboration.NewMultiAgentSystem(agents, collaboration.MultiAgentConfig{
    Pattern:            collaboration.PatternConsensus,
    ConsensusThreshold: 0.7, // 70% 同意即达成共识
    EnableVoting:       true,
}, logger)
```

#### 流水线模式 (Pipeline)

Agent 按顺序处理，前一个的输出是后一个的输入：

```go
mas := collaboration.NewMultiAgentSystem(agents, collaboration.MultiAgentConfig{
    Pattern: collaboration.PatternPipeline,
}, logger)

// 流程：Agent1 → Agent2 → Agent3
// 适用于：研究 → 分析 → 撰写
```

#### 广播模式 (Broadcast)

所有 Agent 并行处理同一输入，汇总结果：

```go
mas := collaboration.NewMultiAgentSystem(agents, collaboration.MultiAgentConfig{
    Pattern: collaboration.PatternBroadcast,
}, logger)

// 流程：
//        ┌→ Agent1 ─┐
// Input ─┼→ Agent2 ─┼→ 汇总
//        └→ Agent3 ─┘
```

#### 网络模式 (Network)

Agent 之间自由通信：

```go
mas := collaboration.NewMultiAgentSystem(agents, collaboration.MultiAgentConfig{
    Pattern: collaboration.PatternNetwork,
}, logger)
```

## 消息中心

Agent 间通信：

```go
// 创建消息中心
hub := collaboration.NewMessageHub(logger)

// 为每个 Agent 创建通道
hub.CreateChannel("agent1")
hub.CreateChannel("agent2")

// 发送消息
hub.Send(&collaboration.Message{
    ID:        "msg1",
    FromID:    "agent1",
    ToID:      "agent2", // 空表示广播
    Type:      collaboration.MessageTypeProposal,
    Content:   "我认为应该采用方案 A",
    Timestamp: time.Now(),
})

// 接收消息
msg, err := hub.Receive("agent2", 30*time.Second)
```

### 消息类型

| 类型 | 说明 |
|------|------|
| `MessageTypeProposal` | 提案 |
| `MessageTypeResponse` | 响应 |
| `MessageTypeVote` | 投票 |
| `MessageTypeConsensus` | 共识结果 |
| `MessageTypeBroadcast` | 广播消息 |

## A2A 协议

Agent-to-Agent 协议，支持跨系统 Agent 互操作：

```go
import "github.com/BaSui01/agentflow/agent/a2a"

// 创建 Agent Card（描述 Agent 能力）
card := a2a.NewAgentCard(
    "code-reviewer",
    "专业的代码审查 Agent",
    "https://api.example.com/agents/code-reviewer",
    "1.0.0",
).
    AddCapability("review", "审查代码质量", a2a.CapabilityTypeTask).
    AddCapability("suggest", "提供改进建议", a2a.CapabilityTypeQuery).
    AddTool("analyze_code", "分析代码结构", codeAnalysisSchema).
    SetInputSchema(inputSchema).
    SetOutputSchema(outputSchema).
    SetMetadata("language", "go,python,javascript")

// 验证 Agent Card
if err := card.Validate(); err != nil {
    log.Fatal(err)
}

// 检查能力
if card.HasCapability("review") {
    // 可以执行代码审查
}

// 获取工具
tool := card.GetTool("analyze_code")
```

### A2A 客户端

```go
// 创建 A2A 客户端
client := a2a.NewClient(a2a.ClientConfig{
    Timeout: 60 * time.Second,
})

// 发现 Agent
agents, err := client.Discover(ctx, "code review")

// 调用远程 Agent
response, err := client.Call(ctx, agentURL, &a2a.Request{
    Task:   "review",
    Input:  codeContent,
    Config: map[string]interface{}{"language": "go"},
})
```

### A2A 服务器

```go
// 创建 A2A 服务器
server := a2a.NewServer(a2a.ServerConfig{
    Port: 8080,
    Card: card,
})

// 注册处理器
server.RegisterHandler("review", func(ctx context.Context, req *a2a.Request) (*a2a.Response, error) {
    // 处理审查请求
    result := reviewCode(req.Input)
    return &a2a.Response{
        Status: "success",
        Output: result,
    }, nil
})

// 启动服务器
server.Start()
```

## Crew 模式

类似 CrewAI 的团队协作：

```go
import "github.com/BaSui01/agentflow/agent/crews"

// 创建 Crew
crew := crews.NewCrew(crews.CrewConfig{
    Name:        "研究团队",
    Description: "负责技术研究和报告撰写",
    Process:     crews.ProcessSequential, // Sequential/Hierarchical
})

// 添加成员
crew.AddMember(crews.Member{
    Agent: researcherAgent,
    Role:  "研究员",
    Goal:  "收集和整理相关资料",
})

crew.AddMember(crews.Member{
    Agent: analystAgent,
    Role:  "分析师",
    Goal:  "分析数据并提取洞察",
})

crew.AddMember(crews.Member{
    Agent: writerAgent,
    Role:  "撰稿人",
    Goal:  "撰写清晰的技术报告",
})

// 定义任务
crew.AddTask(crews.Task{
    Description: "研究 Go 语言的内存管理机制",
    AssignedTo:  "研究员",
    Output:      "研究资料汇总",
})

crew.AddTask(crews.Task{
    Description: "分析内存管理的优缺点",
    AssignedTo:  "分析师",
    DependsOn:   []string{"研究资料汇总"},
    Output:      "分析报告",
})

crew.AddTask(crews.Task{
    Description: "撰写技术博客文章",
    AssignedTo:  "撰稿人",
    DependsOn:   []string{"分析报告"},
    Output:      "博客文章",
})

// 执行
result, err := crew.Kickoff(ctx)
```

## 最佳实践

1. **选择合适的模式**：
   - 需要多角度分析：辩论模式
   - 需要达成一致：共识模式
   - 任务有先后依赖：流水线模式
   - 任务可并行：广播模式

2. **合理设置轮次**：辩论模式不宜过多轮次，3-5 轮通常足够

3. **超时控制**：多 Agent 协作耗时较长，设置合理超时

4. **错误处理**：单个 Agent 失败不应影响整体流程

5. **日志追踪**：记录 Agent 间的消息交互，便于调试
