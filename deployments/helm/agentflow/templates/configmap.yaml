apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "agentflow.fullname" . }}-config
  labels:
    {{- include "agentflow.labels" . | nindent 4 }}
data:
  config.yaml: |
    # =============================================================================
    # AgentFlow Configuration
    # Generated by Helm Chart
    # =============================================================================

    server:
      http_port: {{ .Values.config.server.httpPort }}
      grpc_port: {{ .Values.config.server.grpcPort }}
      metrics_port: {{ .Values.config.server.metricsPort }}
      read_timeout: {{ .Values.config.server.readTimeout | quote }}
      write_timeout: {{ .Values.config.server.writeTimeout | quote }}
      shutdown_timeout: {{ .Values.config.server.shutdownTimeout | quote }}

    agent:
      name: {{ .Values.config.agent.name | quote }}
      model: {{ .Values.config.agent.model | quote }}
      max_iterations: {{ .Values.config.agent.maxIterations }}
      temperature: {{ .Values.config.agent.temperature }}
      max_tokens: {{ .Values.config.agent.maxTokens }}
      timeout: {{ .Values.config.agent.timeout | quote }}
      stream_enabled: {{ .Values.config.agent.streamEnabled }}
      memory:
        enabled: {{ .Values.config.agent.memory.enabled }}
        type: {{ .Values.config.agent.memory.type | quote }}
        max_messages: {{ .Values.config.agent.memory.maxMessages }}
        token_limit: {{ .Values.config.agent.memory.tokenLimit }}

    redis:
      addr: "{{ include "agentflow.redisHost" . }}:{{ .Values.redis.external.port | default 6379 }}"
      db: {{ .Values.redis.external.db | default 0 }}
      pool_size: 10
      min_idle_conns: 2

    {{- if or .Values.postgresql.enabled .Values.postgresql.external.host }}
    database:
      driver: "postgres"
      host: {{ include "agentflow.postgresqlHost" . | quote }}
      port: {{ .Values.postgresql.external.port | default 5432 }}
      user: {{ .Values.postgresql.auth.username | default .Values.postgresql.external.user | quote }}
      name: {{ .Values.postgresql.auth.database | default .Values.postgresql.external.database | quote }}
      ssl_mode: {{ .Values.postgresql.external.sslMode | default "disable" | quote }}
      max_open_conns: 25
      max_idle_conns: 5
      conn_max_lifetime: "5m"
    {{- end }}

    {{- if or .Values.qdrant.enabled .Values.qdrant.external.host }}
    qdrant:
      host: {{ include "agentflow.qdrantHost" . | quote }}
      port: {{ .Values.qdrant.external.port | default 6334 }}
      collection: {{ .Values.qdrant.external.collection | default "agentflow_vectors" | quote }}
    {{- end }}

    log:
      level: {{ .Values.config.log.level | quote }}
      format: {{ .Values.config.log.format | quote }}
      output_paths:
        - "stdout"
      enable_caller: {{ .Values.config.log.enableCaller }}
      enable_stacktrace: false

    telemetry:
      enabled: {{ .Values.config.telemetry.enabled }}
      {{- if .Values.config.telemetry.otlpEndpoint }}
      otlp_endpoint: {{ .Values.config.telemetry.otlpEndpoint | quote }}
      {{- end }}
      service_name: {{ .Values.config.telemetry.serviceName | quote }}
      sample_rate: {{ .Values.config.telemetry.sampleRate }}
